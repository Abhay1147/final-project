{% extends "base.jinja" %}

{% block title %}Dashboard - Habit Tracker{% endblock %}

{% block extra_css %}
<style>
    .coin-balance {
        font-size: 2rem;
        font-weight: bold;
        color: #FFD700;
    }
    
    .habit-card {
        border-left: 4px solid;
        transition: transform 0.2s;
    }
    
    .habit-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .habit-card.completed {
        background-color: #d4edda;
    }
    
    .mark-complete-btn {
        transition: all 0.3s;
    }
    
    .mark-complete-btn:hover {
        transform: scale(1.05);
    }
    
    .mark-complete-btn.completed {
        background-color: #28a745;
        color: white;
    }
    
    .d3-calendar {
        font-family: Arial, sans-serif;
    }
    
    .d3-day {
        stroke: #fff;
        stroke-width: 2px;
    }
    
    .d3-day:hover {
        stroke: #333;
    }
    
    .d3-tooltip {
        position: absolute;
        padding: 8px 12px;
        background: rgba(0, 0, 0, 0.8);
        color: #fff;
        border-radius: 4px;
        pointer-events: none;
        font-size: 12px;
        z-index: 1000;
    }
    
    #habit-calendar {
        overflow-x: auto;
    }
    
    .stats-card {
        text-align: center;
        padding: 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 8px;
        margin-bottom: 20px;
    }
    
    .stats-card h3 {
        margin: 10px 0 5px 0;
        font-size: 2rem;
    }
    
    .stats-card p {
        margin: 0;
        opacity: 0.9;
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <!-- Welcome & Stats -->
    <div class="col-md-8">
        <h1>Welcome, {{ current_user.username }}! ðŸ‘‹</h1>
        <p class="text-muted">Build consistent habits and earn rewards</p>
    </div>
    <div class="col-md-4 text-end">
        <div class="stats-card">
            <i class="fas fa-coins fa-2x"></i>
            <h3>{{ user_coins }}</h3>
            <p>Coins Available</p>
        </div>
    </div>
</div>

<!-- Quick Stats Row -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="stats-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
            <i class="fas fa-check-circle fa-2x"></i>
            <h3>{{ habits_completed_today }}</h3>
            <p>Completed Today</p>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stats-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
            <i class="fas fa-fire fa-2x"></i>
            <h3>{{ current_streak }}</h3>
            <p>Day Streak</p>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stats-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
            <i class="fas fa-tasks fa-2x"></i>
            <h3>{{ total_habits }}</h3>
            <p>Total Habits</p>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stats-card" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
            <i class="fas fa-star fa-2x"></i>
            <h3>{{ completion_rate }}%</h3>
            <p>Completion Rate</p>
        </div>
    </div>
</div>

<!-- Habit Calendar Heatmap -->
<div class="card mb-4">
    <div class="card-header bg-primary text-white">
        <h5 class="mb-0">
            <i class="fas fa-calendar"></i> Habit Completion Heatmap
        </h5>
    </div>
    <div class="card-body">
        <div id="habit-calendar"></div>
    </div>
</div>

<!-- Today's Habits -->
<div class="card mb-4">
    <div class="card-header bg-primary text-white">
        <h5 class="mb-0">
            <i class="fas fa-list-check"></i> Today's Habits
        </h5>
    </div>
    <div class="card-body">
        {% if habits %}
            <div class="row">
                {% for habit in habits %}
                    <div class="col-md-6 mb-3">
                        <div class="habit-card card" style="border-left-color: {{ habit.color or '#007bff' }};">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div style="flex: 1;">
                                        <h5 class="card-title mb-1">
                                            <a href="{{ url_for('view_habit', habit_id=habit.id) }}" style="text-decoration: none; color: inherit;">
                                                <i class="fas {{ habit.icon or 'fa-circle' }}"></i> {{ habit.name }}
                                            </a>
                                        </h5>
                                        <p class="card-text text-muted small">{{ habit.description }}</p>
                                        <span class="badge bg-info">
                                            <i class="fas fa-coins"></i> +{{ habit.coin_reward }} coins
                                        </span>
                                    </div>
                                    <form action="{{ url_for('complete_habit', habit_id=habit.id) }}" method="POST" class="d-inline">
                                        {% if habit.completed_today %}
                                            <button type="button" class="btn btn-success mark-complete-btn completed" disabled>
                                                <i class="fas fa-check"></i> Done!
                                            </button>
                                        {% else %}
                                            <button type="submit" class="btn btn-outline-success mark-complete-btn">
                                                <i class="fas fa-check"></i> Mark Complete
                                            </button>
                                        {% endif %}
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="alert alert-info" role="alert">
                <i class="fas fa-info-circle"></i> No habits yet. 
                <a href="{{ url_for('create_habit') }}" class="alert-link">Create your first habit!</a>
            </div>
        {% endif %}
    </div>
</div>

<!-- Habit Completion Chart -->
<div class="card mb-4">
    <div class="card-header bg-primary text-white">
        <h5 class="mb-0">
            <i class="fas fa-chart-bar"></i> Weekly Completion
        </h5>
    </div>
    <div class="card-body">
        <div id="completion-chart" style="height: 300px;"></div>
    </div>
</div>

<!-- Quick Actions -->
<div class="row mb-4">
    <div class="col-md-4 mb-3">
        <a href="{{ url_for('create_habit') }}" class="btn btn-primary btn-lg w-100">
            <i class="fas fa-plus"></i> Create New Habit
        </a>
    </div>
    <div class="col-md-4 mb-3">
        <a href="{{ url_for('store') }}" class="btn btn-success btn-lg w-100">
            <i class="fas fa-store"></i> Visit Store
        </a>
    </div>
    <div class="col-md-4 mb-3">
        <a href="{{ url_for('profile') }}" class="btn btn-info btn-lg w-100">
            <i class="fas fa-user-circle"></i> View Profile
        </a>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://d3js.org/d3.v7.min.js"></script>
<script>
    // Data passed from Flask backend
    const habitData = {{ habit_log_data | tojson }};
    const weeklyData = {{ weekly_completion_data | tojson }};
    const currentMonth = new Date().getMonth();
    const currentYear = new Date().getFullYear();

    // Habit Calendar Heatmap
    function drawCalendar() {
        const width = 900;
        const cellSize = 13;
        const svg = d3.select("#habit-calendar")
            .append("svg")
            .attr("width", width)
            .attr("height", 150)
            .attr("class", "d3-calendar");

        // Group by weeks
        const data = d3.group(habitData, d => {
            const date = new Date(d.date);
            return d3.timeWeek.count(d3.timeYear(date), date);
        });

        const rect = svg.selectAll("rect")
            .data(habitData)
            .enter()
            .append("rect")
            .attr("class", "d3-day")
            .attr("x", d => {
                const date = new Date(d.date);
                return d3.timeWeek.count(d3.timeYear(date), date) * (cellSize + 2);
            })
            .attr("y", d => {
                const date = new Date(d.date);
                return date.getDay() * (cellSize + 2);
            })
            .attr("width", cellSize)
            .attr("height", cellSize)
            .attr("fill", d => {
                if (d.completed) return "#28a745";
                return "#ebedf0";
            })
            .attr("opacity", d => {
                if (d.completed) return 1;
                return 0.5;
            })
            .on("mouseover", function(event, d) {
                d3.select(this).transition().duration(100)
                    .attr("stroke-width", 3);
                
                const tooltip = d3.select("body")
                    .append("div")
                    .attr("class", "d3-tooltip")
                    .style("left", (event.pageX + 10) + "px")
                    .style("top", (event.pageY - 28) + "px")
                    .html(`${d.date}<br/>${d.completed ? 'âœ“ Completed' : 'Not completed'}`);
                
                setTimeout(() => tooltip.remove(), 2000);
            });
    }

    // Weekly Completion Chart
    function drawCompletionChart() {
        const margin = { top: 20, right: 30, bottom: 30, left: 60 };
        const width = 800 - margin.left - margin.right;
        const height = 300 - margin.top - margin.bottom;

        const svg = d3.select("#completion-chart")
            .append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);

        const x = d3.scaleBand()
            .domain(weeklyData.map(d => d.day))
            .range([0, width])
            .padding(0.1);

        const y = d3.scaleLinear()
            .domain([0, 100])
            .range([height, 0]);

        // Bars
        svg.selectAll(".bar")
            .data(weeklyData)
            .enter()
            .append("rect")
            .attr("class", "bar")
            .attr("x", d => x(d.day))
            .attr("y", d => y(d.completion))
            .attr("width", x.bandwidth())
            .attr("height", d => height - y(d.completion))
            .attr("fill", "#667eea");

        // X Axis
        svg.append("g")
            .attr("transform", `translate(0,${height})`)
            .call(d3.axisBottom(x));

        // Y Axis
        svg.append("g")
            .call(d3.axisLeft(y));

        // Labels
        svg.append("text")
            .attr("y", 0 - (margin.top))
            .attr("x", 0 - (height / 2))
            .attr("dy", "1em")
            .style("text-anchor", "middle")
            .text("Completion %");
    }

    // Initialize charts
    drawCalendar();
    drawCompletionChart();
</script>
{% endblock %}
